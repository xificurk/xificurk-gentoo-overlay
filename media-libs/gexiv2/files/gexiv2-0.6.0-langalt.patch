From 6105cc84bf74ee7124975fc1501401015ca49620 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20Mor=C3=A1vek=20=5BXificurk=5D?= <petr@pada.cz>
Date: Sun, 19 May 2013 15:00:03 +0200
Subject: [PATCH] Add methods for manipulating XMP LangAlt tags.

---
 gexiv2/gexiv2-metadata-private.h |  2 ++
 gexiv2/gexiv2-metadata-xmp.cpp   | 61 ++++++++++++++++++++++++++++++++++++++++
 gexiv2/gexiv2-metadata.cpp       | 23 +++++++++++++++
 gexiv2/gexiv2-metadata.h         | 16 +++++++++++
 4 files changed, 102 insertions(+)

diff --git a/gexiv2/gexiv2-metadata-private.h b/gexiv2/gexiv2-metadata-private.h
index ed94f5f..253de70 100644
--- a/gexiv2/gexiv2-metadata-private.h
+++ b/gexiv2/gexiv2-metadata-private.h
@@ -61,6 +61,8 @@ glong			gexiv2_metadata_get_xmp_tag_long	(GExiv2Metadata *self, const gchar* tag
 gboolean		gexiv2_metadata_set_xmp_tag_long	(GExiv2Metadata *self, const gchar* tag, glong value);
 gchar**			gexiv2_metadata_get_xmp_tag_multiple (GExiv2Metadata *self, const gchar* tag);
 gboolean		gexiv2_metadata_set_xmp_tag_multiple (GExiv2Metadata *self, const gchar* tag, const gchar** values);
+gchar**         gexiv2_metadata_get_xmp_tag_langalt (GExiv2Metadata *self, const gchar* tag);
+gboolean        gexiv2_metadata_set_xmp_tag_langalt (GExiv2Metadata *self, const gchar* tag, const gchar** values);
 
 const gchar*	gexiv2_metadata_get_xmp_tag_label		(const gchar* tag);
 const gchar*	gexiv2_metadata_get_xmp_tag_description	(const gchar* tag);
diff --git a/gexiv2/gexiv2-metadata-xmp.cpp b/gexiv2/gexiv2-metadata-xmp.cpp
index 4f911a6..1e99a4d 100644
--- a/gexiv2/gexiv2-metadata-xmp.cpp
+++ b/gexiv2/gexiv2-metadata-xmp.cpp
@@ -259,6 +259,67 @@ gboolean gexiv2_metadata_set_xmp_tag_multiple (GExiv2Metadata *self, const gchar
     return FALSE;
 }
 
+gchar** gexiv2_metadata_get_xmp_tag_langalt (GExiv2Metadata *self, const gchar* tag) {
+    g_return_val_if_fail(GEXIV2_IS_METADATA (self), NULL);
+    g_return_val_if_fail(tag != NULL, NULL);
+    g_return_val_if_fail(self->priv->image.get() != NULL, NULL);
+    
+    Exiv2::XmpData& xmp_data = self->priv->image->xmpData();
+    
+    try {
+        Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
+        
+        if (it != xmp_data.end()) {
+            int size = it->count ();
+            gchar **array = g_new (gchar*, size + 1);
+            array[size] = NULL;
+            
+            const Exiv2::LangAltValue &value = static_cast<const Exiv2::LangAltValue &>(it->value());
+            
+            int index = 0;
+            for (Exiv2::LangAltValue::ValueType::const_iterator i = value.value_.begin(); i != value.value_.end(); ++i)
+                array[index++] = g_strdup_printf("lang=\"%s\" %s", (i->first).c_str(), (i->second).c_str());
+            
+            return array;
+        }
+    } catch (Exiv2::Error& e) {
+        LOG_ERROR(e);
+    }
+    
+    gchar **array = g_new (gchar*, 1);
+    array[0] = NULL;
+    
+    return array;
+}
+
+gboolean gexiv2_metadata_set_xmp_tag_langalt (GExiv2Metadata *self, const gchar* tag, 
+    const gchar** values) {
+    g_return_val_if_fail(GEXIV2_IS_METADATA (self), FALSE);
+    g_return_val_if_fail(tag != NULL, FALSE);
+    g_return_val_if_fail(values != NULL, FALSE);
+    g_return_val_if_fail(self->priv->image.get() != NULL, FALSE);
+    
+    Exiv2::XmpData& xmp_data = self->priv->image->xmpData();
+    
+    try {
+        /* first clear existing tag */
+        gexiv2_metadata_clear_xmp_tag(self, tag);
+        
+        /* ... and then set the others */
+        const gchar **val_it = values;
+        while (*val_it != NULL) {
+            xmp_data[tag] = static_cast<const std::string> (*val_it);
+            ++val_it;
+        }
+        
+        return TRUE;
+    } catch (Exiv2::Error& e) {
+        LOG_ERROR(e);
+    }
+    
+    return FALSE;
+}
+
 const gchar* gexiv2_metadata_get_xmp_tag_label (const gchar* tag) {
     g_return_val_if_fail(tag != NULL, NULL);
     
diff --git a/gexiv2/gexiv2-metadata.cpp b/gexiv2/gexiv2-metadata.cpp
index b7d6a9a..68d36f4 100644
--- a/gexiv2/gexiv2-metadata.cpp
+++ b/gexiv2/gexiv2-metadata.cpp
@@ -726,6 +726,29 @@ gboolean gexiv2_metadata_set_tag_multiple(GExiv2Metadata *self, const gchar* tag
     return FALSE;
 }
 
+gchar** gexiv2_metadata_get_tag_langalt(GExiv2Metadata *self, const gchar* tag) {
+    g_return_val_if_fail(GEXIV2_IS_METADATA(self), NULL);
+    g_return_val_if_fail(tag != NULL, NULL);
+    g_return_val_if_fail(self->priv->image.get() != NULL, NULL);
+    
+    if (gexiv2_metadata_is_xmp_tag(tag))
+        return gexiv2_metadata_get_xmp_tag_langalt(self, tag);
+    
+    return NULL;
+}
+
+gboolean gexiv2_metadata_set_tag_langalt(GExiv2Metadata *self, const gchar* tag, const gchar** values) {
+    g_return_val_if_fail(GEXIV2_IS_METADATA(self), FALSE);
+    g_return_val_if_fail(tag != NULL, FALSE);
+    g_return_val_if_fail(values != NULL, FALSE);
+    g_return_val_if_fail(self->priv->image.get() != NULL, FALSE);
+    
+    if (gexiv2_metadata_is_xmp_tag(tag))
+        return gexiv2_metadata_set_xmp_tag_langalt(self, tag, values);
+    
+    return FALSE;
+}
+
 glong gexiv2_metadata_get_tag_long(GExiv2Metadata *self, const gchar* tag) {
     g_return_val_if_fail(GEXIV2_IS_METADATA(self), 0);
     g_return_val_if_fail(tag != NULL, 0);
diff --git a/gexiv2/gexiv2-metadata.h b/gexiv2/gexiv2-metadata.h
index ebeb01c..460cbee 100644
--- a/gexiv2/gexiv2-metadata.h
+++ b/gexiv2/gexiv2-metadata.h
@@ -182,6 +182,22 @@ gchar**			gexiv2_metadata_get_tag_multiple	(GExiv2Metadata *self, const gchar* t
 gboolean		gexiv2_metadata_set_tag_multiple	(GExiv2Metadata *self, const gchar* tag, const gchar** values);
 
 /**
+ * gexiv2_metadata_get_tag_langalt:
+ * @tag: The name of the tag to get
+ *
+ * Returns: (transfer full) (allow-none) (array zero-terminated=1): The langalt values of that tag
+ */
+gchar**         gexiv2_metadata_get_tag_langalt    (GExiv2Metadata *self, const gchar* tag);
+
+/**
+ * gexiv2_metadata_set_tag_langalt:
+ * @values: (array zero-terminated=1): An array of tags that you want to set
+ *
+ * Returns: (transfer full): Boolean success value
+ */
+gboolean        gexiv2_metadata_set_tag_langalt    (GExiv2Metadata *self, const gchar* tag, const gchar** values);
+
+/**
  * gexiv2_metadata_get_exposure_time:
  * @nom: (out): The numerator
  * @den: (out): The denominator
-- 
1.8.1.5

