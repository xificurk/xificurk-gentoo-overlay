From 3ab45298c8e65ca89ecb50f6cd942b4f957981b3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20Mor=C3=A1vek=20=5BXificurk=5D?= <petr@pada.cz>
Date: Sun, 19 May 2013 12:46:50 +0200
Subject: [PATCH] Take into account tags that are present, but have zero
 length.

---
 gexiv2/gexiv2-metadata-exif.cpp | 26 ++++++--------------------
 gexiv2/gexiv2-metadata-iptc.cpp | 29 +++++++----------------------
 gexiv2/gexiv2-metadata-xmp.cpp  | 31 +++++++------------------------
 3 files changed, 20 insertions(+), 66 deletions(-)

diff --git a/gexiv2/gexiv2-metadata-exif.cpp b/gexiv2/gexiv2-metadata-exif.cpp
index 3540499..6cfa2c1 100644
--- a/gexiv2/gexiv2-metadata-exif.cpp
+++ b/gexiv2/gexiv2-metadata-exif.cpp
@@ -31,7 +31,7 @@ gboolean gexiv2_metadata_has_exif_tag(GExiv2Metadata *self, const gchar* tag) {
     
     Exiv2::ExifData &exif_data = self->priv->image->exifData();
     for (Exiv2::ExifData::iterator it = exif_data.begin(); it != exif_data.end(); ++it) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
             return TRUE;
     }
     
@@ -49,7 +49,7 @@ gboolean gexiv2_metadata_clear_exif_tag(GExiv2Metadata *self, const gchar* tag)
     
     Exiv2::ExifData::iterator it = exif_data.begin();
     while (it != exif_data.end()) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
             it = exif_data.erase(it);
             erased = TRUE;
         } else {
@@ -81,10 +81,8 @@ gchar** gexiv2_metadata_get_exif_tags (GExiv2Metadata *self) {
     gint count = 0;
     
     for (Exiv2::ExifData::iterator it = exif_data.begin(); it != exif_data.end(); ++it) {
-        if (it->count() > 0) {
             list = g_slist_prepend (list, g_strdup (it->key ().c_str ()));
             count++;
-        }
     }
     
     data = g_new (gchar*, count + 1);
@@ -106,11 +104,9 @@ gchar* gexiv2_metadata_get_exif_tag_string (GExiv2Metadata *self, const gchar* t
     
     try {
         Exiv2::ExifData::iterator it = exif_data.findKey(Exiv2::ExifKey(tag));
-        while (it != exif_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != exif_data.end())
+        if (it != exif_data.end()) {
             return g_strdup (it->toString ().c_str ());
+        }
     } catch (Exiv2::Error& e) {
         LOG_ERROR(e);
     }
@@ -127,13 +123,9 @@ gchar* gexiv2_metadata_get_exif_tag_interpreted_string (GExiv2Metadata *self, co
     
     try {
         Exiv2::ExifData::iterator it = exif_data.findKey(Exiv2::ExifKey(tag));
-        while (it != exif_data.end() && it->count() == 0)
-            it++;
-        
         if (it != exif_data.end()) {
             std::ostringstream os;
             it->write (os);
-            
             return g_strdup (os.str ().c_str ());
         }
     } catch (Exiv2::Error& e) {
@@ -169,11 +161,9 @@ glong gexiv2_metadata_get_exif_tag_long (GExiv2Metadata *self, const gchar* tag)
     
     try {
         Exiv2::ExifData::iterator it = exif_data.findKey(Exiv2::ExifKey(tag));
-        while (it != exif_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != exif_data.end())
+        if (it != exif_data.end()) {
             return it->toLong ();
+        }
     } catch (Exiv2::Error& e) {
         LOG_ERROR(e);
     }
@@ -209,14 +199,10 @@ gboolean gexiv2_metadata_get_exif_tag_rational (GExiv2Metadata *self, const gcha
     
     try {
         Exiv2::ExifData::iterator it = exif_data.findKey(Exiv2::ExifKey(tag));
-        while (it != exif_data.end() && it->count() == 0)
-            it++;
-        
         if (it != exif_data.end()) {
             Exiv2::Rational r = it->toRational();
             *nom = r.first;
             *den = r.second;
-            
             return TRUE;
         }
     } catch (Exiv2::Error& e) {
diff --git a/gexiv2/gexiv2-metadata-iptc.cpp b/gexiv2/gexiv2-metadata-iptc.cpp
index 4a1d9ff..78e1ea1 100644
--- a/gexiv2/gexiv2-metadata-iptc.cpp
+++ b/gexiv2/gexiv2-metadata-iptc.cpp
@@ -31,7 +31,7 @@ gboolean gexiv2_metadata_has_iptc_tag(GExiv2Metadata *self, const gchar* tag) {
     Exiv2::IptcData &iptc_data = self->priv->image->iptcData();
     
     for (Exiv2::IptcData::iterator it = iptc_data.begin(); it != iptc_data.end(); ++it) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
             return TRUE;
     }
     
@@ -49,7 +49,7 @@ gboolean gexiv2_metadata_clear_iptc_tag(GExiv2Metadata *self, const gchar* tag)
     
     Exiv2::IptcData::iterator it = iptc_data.begin();
     while (it != iptc_data.end()) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
             it = iptc_data.erase(it);
             erased = TRUE;
         } else {
@@ -81,10 +81,8 @@ gchar** gexiv2_metadata_get_iptc_tags (GExiv2Metadata *self) {
     gint count = 0;
     
     for (Exiv2::IptcData::iterator it = iptc_data.begin(); it != iptc_data.end(); ++it) {
-        if (it->count() > 0) {
             list = g_slist_prepend (list, g_strdup (it->key ().c_str ()));
             count++;
-        }
     }
     
     data = g_new (gchar*, count + 1);
@@ -106,11 +104,9 @@ gchar* gexiv2_metadata_get_iptc_tag_string (GExiv2Metadata *self, const gchar* t
     
     try {
         Exiv2::IptcData::iterator it = iptc_data.findKey(Exiv2::IptcKey(tag));
-        while (it != iptc_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != iptc_data.end())
+        if (it != iptc_data.end()) {
             return g_strdup (it->toString ().c_str ());
+        }
     } catch (Exiv2::Error& e) {
         LOG_ERROR(e);
     }
@@ -127,13 +123,9 @@ gchar* gexiv2_metadata_get_iptc_tag_interpreted_string (GExiv2Metadata *self, co
     
     try {
         Exiv2::IptcData::iterator it = iptc_data.findKey(Exiv2::IptcKey(tag));
-        while (it != iptc_data.end() && it->count() == 0)
-            it++;
-        
         if (it != iptc_data.end()) {
             std::ostringstream os;
             it->write (os);
-            
             return g_strdup (os.str ().c_str ());
         }
     } catch (Exiv2::Error& e) {
@@ -174,9 +166,8 @@ gchar** gexiv2_metadata_get_iptc_tag_multiple (GExiv2Metadata *self, const gchar
     gint count = 0;
     
     try {
-        Exiv2::IptcKey key (tag);
         for (Exiv2::IptcData::iterator it = iptc_data.begin(); it != iptc_data.end(); ++it) {
-            if (it->count() > 0 && key.key () == it->key ()) {
+            if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
                 list = g_slist_prepend (list, g_strdup (it->toString ().c_str ()));
                 count++;
             }
@@ -208,16 +199,10 @@ gboolean gexiv2_metadata_set_iptc_tag_multiple (GExiv2Metadata *self, const gcha
     
     try {
         /* first clear all existing ... */
-        Exiv2::IptcKey iptc_key(tag);
-        Exiv2::IptcData::iterator iptc_it = iptc_data.begin();
-        while (iptc_it != iptc_data.end()) {
-            if (iptc_it->count() > 0 && iptc_key.key () == iptc_it->key ())
-                iptc_it = iptc_data.erase (iptc_it);
-            else
-                ++iptc_it;
-        }
+        gexiv2_metadata_clear_iptc_tag(self, tag);
         
         /* ... and then set the others */
+        Exiv2::IptcKey iptc_key(tag);
         Exiv2::Value::AutoPtr iptc_value = Exiv2::Value::create(Exiv2::string);
             
         const gchar **it = values;
diff --git a/gexiv2/gexiv2-metadata-xmp.cpp b/gexiv2/gexiv2-metadata-xmp.cpp
index b857ef5..4f911a6 100644
--- a/gexiv2/gexiv2-metadata-xmp.cpp
+++ b/gexiv2/gexiv2-metadata-xmp.cpp
@@ -51,7 +51,7 @@ gboolean gexiv2_metadata_has_xmp_tag(GExiv2Metadata *self, const gchar* tag) {
     Exiv2::XmpData &xmp_data = self->priv->image->xmpData();
     
     for (Exiv2::XmpData::iterator it = xmp_data.begin(); it != xmp_data.end(); ++it) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0)
             return TRUE;
     }
     
@@ -69,7 +69,7 @@ gboolean gexiv2_metadata_clear_xmp_tag(GExiv2Metadata *self, const gchar* tag) {
     
     Exiv2::XmpData::iterator it = xmp_data.begin();
     while (it != xmp_data.end()) {
-        if (it->count() > 0 && g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
+        if (g_ascii_strcasecmp(tag, it->key().c_str()) == 0) {
             it = xmp_data.erase(it);
             erased = TRUE;
         } else {
@@ -94,10 +94,8 @@ gchar** gexiv2_metadata_get_xmp_tags (GExiv2Metadata *self) {
     gint count = 0;
     
     for (Exiv2::XmpData::iterator it = xmp_data.begin(); it != xmp_data.end(); ++it) {
-        if (it->count() > 0) {
             list = g_slist_prepend (list, g_strdup (it->key ().c_str ()));
             count++;
-        }
     }
     
     data = g_new (gchar*, count + 1);
@@ -119,11 +117,9 @@ gchar* gexiv2_metadata_get_xmp_tag_string (GExiv2Metadata *self, const gchar* ta
     
     try {
         Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
-        while (it != xmp_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != xmp_data.end())
+        if  (it != xmp_data.end()) {
             return g_strdup (it->toString ().c_str ());
+        }
     } catch (Exiv2::Error& e) {
         LOG_ERROR(e);
     }
@@ -140,13 +136,9 @@ gchar* gexiv2_metadata_get_xmp_tag_interpreted_string (GExiv2Metadata *self, con
     
     try {
         Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
-        while (it != xmp_data.end() && it->count() == 0)
-            it++;
-        
         if (it != xmp_data.end()) {
             std::ostringstream os;
             it->write (os);
-            
             return g_strdup (os.str ().c_str ());
         }
     } catch (Exiv2::Error& e) {
@@ -183,11 +175,9 @@ glong gexiv2_metadata_get_xmp_tag_long (GExiv2Metadata *self, const gchar* tag)
     
     try {
         Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
-        while (it != xmp_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != xmp_data.end())
+        if (it != xmp_data.end()) {
             return it->toLong ();
+        }
     } catch (Exiv2::Error& e) {
         LOG_ERROR(e);
     }
@@ -220,8 +210,6 @@ gchar** gexiv2_metadata_get_xmp_tag_multiple (GExiv2Metadata *self, const gchar*
     
     try {
         Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
-        while (it != xmp_data.end() && it->count() == 0)
-            it++;
         
         if (it != xmp_data.end()) {
             int size = it->count ();
@@ -254,12 +242,7 @@ gboolean gexiv2_metadata_set_xmp_tag_multiple (GExiv2Metadata *self, const gchar
     
     try {
         /* first clear existing tag */
-        Exiv2::XmpData::iterator it = xmp_data.findKey(Exiv2::XmpKey(tag));
-        while (it != xmp_data.end() && it->count() == 0)
-            it++;
-        
-        if (it != xmp_data.end())
-            xmp_data.erase (it);
+        gexiv2_metadata_clear_xmp_tag(self, tag);
         
         /* ... and then set the others */
         const gchar **val_it = values;
-- 
1.8.1.5

